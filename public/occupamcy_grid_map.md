---
title: 【図解】占有格子地図（occupancy grid map）徹底解説　
tags:
  - ロボット
  - robotics
private: false
updated_at: '2023-09-22T01:41:42+09:00'
id: 7bcd0818f8f76f7181d2
organization_url_name: null
slide: false
ignorePublish: false
---
:::note
こちらの記事は，[ロボティクスの辞書的な記事（にしたい記事）](https://qiita.com/akinami/items/eb0741b0d9c322e5d5ec)のコンテンツです．
:::

# 占有格子地図（occupancy grid map）とは？
占有格子地図（占有グリッドマップとも呼ばれる）とは、

**環境を格子（grid）状に分割した時に、各セル内が占有されているか否か（=障害物があるか否か）を表現した地図**

です。

<br>
<br>

この際、各セルは「占有=1」or「非占有=0」のどちらかになりますが、占有格子地図では
- 各セルが占有されているか否かを確率的に表す

ということをやっています。例えば、あるセルが占有されている確率が0.8の場合、そのセルには
- 80%の確率で障害物がある

ということになります。
![image.png](https://qiita-image-store.s3.ap-northeast-1.amazonaws.com/0/2030125/967e24e4-ddae-0e74-6826-1407581fe09d.png)

<br>
<br>

各セルが占有されている確立は、lidar等から得られるセンサ値$z$
（$z=0$（障害物なし）、$z=1$（障害物あり）の2値）
を元に推定されます。
![image.png](https://qiita-image-store.s3.ap-northeast-1.amazonaws.com/0/2030125/a3e1d66f-e3d4-3338-cb78-1b8ccb614c9c.png)
「センサから障害物があるか否かの情報が得られているのだから$z$をそのまま採用すればよいのでは？」と思う方もいるかもしれません。

しかし、センサにはノイズが発生するため、ある時刻$t$に「$z_t=1$という観測値が得られたけど、実際は障害物が無かった」という状況（その逆もしかり）があるかもしれません。

そこで、「確率」の登場です。
以下の2パターンの例を考えて見ましょう。
- パターン1：1時刻だけ$z_t=1$と認識された場合
- パターン2：10時刻連続で$z_t=1$と認識された場合

![image.png](https://qiita-image-store.s3.ap-northeast-1.amazonaws.com/0/2030125/de674da6-d561-43b7-6c83-54c36070dc47.png)


パターン1と2を比べると、直感的にも「パターン2のほうが障害物がある確率が高そう」と予測できます（パターン1はノイズの可能性がありそう）。

占有格子地図でも同様の考え方で地図が更新され、「パターン1の方がセルが占有されている確立が低く」　なり「パターン2の方がセルが占有されている確立が高く」なります。

::: note
占有格子地図を使用すると、移動ロボットが障害物を避けながら走行をしたい場合などに、より安全に走行することが可能になります。

例えば、
- 占有されている確立が0.8以上ならば、その領域には障害物があるとみなす
- 占有されている確立が0.2未満ならば、その領域には障害物がないとみなす

といった閾値を設けることで障害物の有無を判定することができます。

また、「安全性を高めたいので閾値を厳し目に設定する」など閾値を変更することで、状況に応じた柔軟な地図作成を行うこともできます。
:::

# 数式を読み解く

ここまでの考え方を数式で表現してみます。

## バイナリベイズフィルタ
最初に地図全体の話をする前に、ロボットが環境をセンシングした時に得られる「センサ値$z$」より「障害物の有無」を推定する方法である
- バイナリベイズフィルタ

について説明したいと思います。
![image.png](https://qiita-image-store.s3.ap-northeast-1.amazonaws.com/0/2030125/965748c6-76e5-5027-64a6-7db01c134470.png)


<br>
<br>

「現時刻までのセンサ値 $z_{1:t}$」という条件のもとで「障害物が存在する状態$x$」である確率（=センサ値を元に障害物の有無を推定）は、式(1)で表すことができます。

```math
p(x|z_{1:t}) = \frac{p(z_t|x, z_{1:t-1})p(x|z_{1:t-1})}{p(z_t|z_{1:t-1})} \tag{1}

```


ここで式(1)の$p(z_t|x, z_{1:t-1})$にマルコフ性がある（現在のセンサ値は、過去のセンサ値にまったく依存しない）と仮定すると、式(1)は式(2)のように変換されます。

```math
p(x|z_{1:t}) = \frac{p(z_t|x)p(x|z_{1:t-1})}{p(z_t|z_{1:t-1})} \tag{2}
```

![image.png](https://qiita-image-store.s3.ap-northeast-1.amazonaws.com/0/2030125/e0480a35-9c12-f0c1-5bdc-c2445b8cee62.png)


::: note warn
ここで、実際にはマルコフ性はないことに注意してください（詳しくは、本ページ下部の[補足](#補足：マルコフ性が成り立たない時)に記述します）．しかし，ここではマルコフ性がある前提で話を進めます。
:::


ここで，式(2)の $p(z_t|x)$ に着目してみます．
これは，「障害物が存在する状態 $x$」という条件のもとで「観測値 $z$」である確率を求めています（=障害物の有無の状態からセンサ値を推定）．
![image.png](https://qiita-image-store.s3.ap-northeast-1.amazonaws.com/0/2030125/29a9d63a-27e7-1444-b530-42a7c2027a3f.png)



しかし，実際の状況を想定すると下図のように「センサ値 $z$（既知）」を元に「障害物が存在する状態 $x$（未知）」である確率を求めるという順番であり， $p(z_t|x)$ とは逆です．
![image.png](https://qiita-image-store.s3.ap-northeast-1.amazonaws.com/0/2030125/6c5d429c-ed5b-0c13-0f38-3d26192fb488.png)




そこで，ベイズの定理により式(2)を式(3)に変換します．
```math
p(x|z_{1:t}) = \frac{p(x|z_t)p(z_t)}{p(x)} \frac{p(x|z_{1:t-1})}{p(z_t|z_{1:t-1})} \tag{3}
```

![image.png](https://qiita-image-store.s3.ap-northeast-1.amazonaws.com/0/2030125/39101a89-0efc-e855-5ab6-4938331bb488.png)


::: note
上記のように
「センサ値 $z_t」$から「障害物が存在する状態 $x$」であるかを推定をするようなモデルは

測定値（出力）である「センサの観測値$z$」から**逆**算して「障害物が存在する状態 $x$」である確率を求めるため
- **inverse** sensor model
 
と呼ばれています。
:::

<!--
同様の手順により「障害物がない状態である確率$\bar{x}$」についても導出できます。
```math
p(\bar{x}|z_{1:t}) = \frac{p(\bar{x}|z_t)p(z_t)}{p(\bar{x})} \frac{p(\bar{x}|z_{1:t-1})}{p(z_t|z_{1:t-1})} \tag{4}
```
-->

<br>
<br>

次に，求めた式(3)を式(4)のオッズ[^2]の形にします．

```math
\begin{align}
\frac{p(x|z_{1:t})}{1-p(x|z_{1:t})} &=  \frac{p(x|z_t)}{1-p(x|z_t)} \frac{1-p(x)}{p(x)} \frac{p(x|z_{1:t-1})}{1-p(x|z_{1:t-1})} \frac{p(z_t|z_{1:t-1})}{p(z_t|z_{1:t-1})}\\
 &= \frac{p(x|z_t)}{1-p(x|z_t)} \frac{1-p(x)}{p(x)} \frac{p(x|z_{1:t-1})}{1-p(x|z_{1:t-1})} \tag{4}
\end{align} 
```

<br>
<br>

そして、式(4)のlog（対数）を取った式(5)の形にします。
```math
\begin{align}
\log\frac{p(x|z_{1:t})}{1-p(x|z_{1:t})} 
&= \log \frac{p(x|z_t)}{1-p(x|z_t)} \frac{1-p(x)}{p(x)} \frac{p(x|z_{1:t-1})}{1-p(x|z_{1:t-1})} \\
& = \log\frac{p(x|z_t)}{1-p(x|z_t)} + \log\frac{1-p(x)}{p(x)} + \log\frac{p(x|z_{1:t-1})}{1-p(x|z_{1:t-1})} \tag{5}
\end{align}
```

<br>
<br>

ここで、式(5)の 「対数オッズ $\log\frac{p(x|z_{1:t})}{1-p(x|z_{1:t})}$」 を $l_t(x)$ に置き換えます（式(6)）（単に、文字に置き換えただけです）。
```math
\begin{align}
l_t(x) = \log\frac{p(x|z_t)}{1-p(x|z_t)} + \log\frac{1-p(x)}{p(x)} + l_{t-1}(x) \tag{6}
\end{align}
```
![image.png](https://qiita-image-store.s3.ap-northeast-1.amazonaws.com/0/2030125/59abe486-bc02-ac52-077a-125f828336b1.png)


<br>

式(6)で完成でも良いのですが、以降で式の説明が若干しづらいので式(6)を式(7)のように変形します（式の意味としては式(6)と全く同じです。）。
```math
\begin{align}
l_t(x)  &= \log\frac{p(x|z_t)}{1-p(x|z_t)} + l_{t-1}(x) - \log\frac{p({x})}{1-p(x)}   \tag{7}
\end{align}
```
:::note
- $l_t(x)$：「現時刻までのセンサ値$z_{1:t}$」から推定した「障害物が存在する $x$」である確立の対数オッズ

- $\log\frac{p(x|z_t)}{1-p(x|z_t)}$：「現時刻のセンサ値$z_{t}$」から推定した「障害物が存在する $x$」である確立の対数オッズ

- $l_{t-1}(x)$：1時刻前の $l_t(x)$

- $\log\frac{p({x})}{1-p(x)}$：「障害物が存在する $x$」である確立の対数オッズ（事前確立）
:::


<br>
<br>

:::note 
オッズのlogを取ったものは、「対数オッズ」と呼ばれ、log（対数）の特性の1つである
- 掛け算が足し算になる

といったメリットを受けることができます。

もう少し詳しくいうと
- 確率値は0〜1の間の値なので，掛け算になると数値が小さくなりすぎて数値誤差が発生しやすい。一方でlogを取ると足し算になるので、それを防げる
- 単純に，掛け算よりも足し算の方が（コンピュータの）計算速度が速い

というメリットがあります．

<br>

また、logを取ると
- 確立値の範囲である「0〜1」から「-∞〜∞」に範囲が拡張される

のも嬉しい（数値誤差の観点から）ところです。
:::

先ほど求めた式(7)の詳細を確認してみましょう（再掲）。
```math
\begin{align}
l_t(x)  &= \log\frac{p(x|z_t)}{1-p(x|z_t)} + l_{t-1}(x) - \log\frac{p({x})}{1-p(x)}   \tag{7（再掲）}
\end{align}
```

<br>

まず右辺の1項目 $\log\frac{p(x|z_t)}{1-p(x|z_t)}$ は
- 「現時刻のセンサ値 $z_t$」を元に「障害物の有無」を推定しています。

しています。
今回 $z_t$ は2種類の値を取るので，パターンとしては以下の2種類になります。
- $p(x|z_t=0)$：$z_t=0$ の時に「障害物が存在する状態 $x$」である確率
- $p(x|z_t=1)$：$z_t=1$ の時に「障害物が存在する状態 $x$」である確率


::: note
それぞれの確率はセンサの性能や環境によって変わります．そのため，実環境で使用する場合は，実際のセンサを使ってみて上記の2つの確率を事前に調べておく必要があります．
:::


<br>
<br>


次に，2項目 $l_{t-1}(x)$ は
- 1時刻前の対数オッズ

となります。


<br>
<br>

最後に，3項目 $\log\frac{p({x})}{1-p(x)}$ についてです．これは
- 事前確率

になります。

例えば、最初の時点（センシングするより前の時点）で障害物の有無がある程度わかっている場合は、障害物付近の確率値を予め高く設定しておくことができると思います。
![image.png](https://qiita-image-store.s3.ap-northeast-1.amazonaws.com/0/2030125/053589e8-39f5-5271-ed56-2583b8ab54d3.png)


しかし、「予め確立を高く設定した領域」と「そうでない領域」を同じように更新してしまうと、「予め確立を高く設定した領域」の $l_t(x)$ が高くなりすぎてしまいます。
そこで、　$\log\frac{p({x})}{1-p(x)}$　を引くことで、 バランスを取るイメージです。
（「予め確立を低く設定した領域」の場合は、3項目がプラスになるのでこの逆の考え方になります）

逆に、事前情報が全くない場合は「障害物がある確立 $p(x)$」と「障害物がない確立 $1-p(x)$」が同じになるので
$$
\log \frac{p(x)}{1-p(x)}  = \log \frac{0.5}{0.5} = 0
$$

となり、3項目は無視することができる、すなわち1項目のセンサ値のみを用いて「障害物の有無」を推定することになります。

実際に、最後のまとめで紹介するソースコードでは3項目が省略された形で実装されています。

<br>
<br>

ここまでの説明をもとに、式(7)を，わかりやすいイメージで言い換えてみると（厳密には対数オッズですが）

「新しい（=現時刻までの）障害物の有無の確率（$1:t$）」=
　　「現時刻のセンサ値から推定された障害物の有無の確率($t$)」 
　+ 「1時刻前までの障害物の有無の確率（$1:t-1$）」 
　- 「（事前確率）」

ということになります。

::: note
以降の、占有格子地図でも同じような式が出てきますが、その際は図付きで説明しているので、そちらの方がイメージが湧きやすいかもしれません。

この時点でイメージが浮かばない方は、とりあえず先を読み進めてみてください。
:::

<!--
式(8)により更新することで、より安全に障害物の有無を推定できます
-->

## 占有格子地図

ここからは、本題である占有格子地図の話に入っていきます。

<br>

最初に、以下の格子地図における表現のバリエーションを考えてみましょう。
![image.png](https://qiita-image-store.s3.ap-northeast-1.amazonaws.com/0/2030125/0ff14a78-2918-5d3c-7cca-d3a521a411c9.png)


<br>

地図は「2×2=4のセル」をもっており、各セルは、「0か1の2種類の状態」をもつため、考えられる地図のパターンは$2^4=16$パターンになります。
![image.png](https://qiita-image-store.s3.ap-northeast-1.amazonaws.com/0/2030125/b5fd9635-c55b-5d9c-ed27-a42e82c537d8.png)



これを一般化してみましょう。マップ$m$のセル数を$|m|$とすると、$|m|$個のセルをもつ地図の表現のパターンは「$2^{|m|}$パターン」になります。

$|m|$に適当な値を入れてみればわかると思いますが、この場合$|m|$を少し大きくしただけで$2^{|m|}$の値は爆発的に大きくなってしまいます（次元の呪い）。

そこで、「各セルが独立している」という仮定のもと各セルが占有されている確立を求めることにしましょう。


::: note warn
「各セルが独立している」というのは正しくありません。
なぜなら、現実の環境は連続的であるためセルをまたぐように障害物が存在することは当たり前のようにあるからです。
![image.png](https://qiita-image-store.s3.ap-northeast-1.amazonaws.com/0/2030125/850338e6-6f57-f3d6-45b3-60927d06c25a.png)

しかし、「各セルが独立している」と考えたほうが都合が良いのでここではそのように考えます。
:::


各セルにおいて、「占有されている確率」と「占有されていない確率」の2パターンを考えるとすると必要な計算量は$2|m|$になり、これは$|m|$をある程度増やしても現実的な計算量になります。

そして、全てのセルは独立であると仮定しているため、式(9)のように表すことができます[^1]。
```math
p(m|z_{1:t},x_{1:t}) = \prod_{i}p(\boldsymbol{\rm{m}}_i|z_{1:t}, x_{1:t}) \tag{8}
```
::: note
- $m$： 地図全体

- $\boldsymbol{\rm{m}}_i$： $i$番目のセル

- $z_{1:t}$：現時刻までのセンサ値

- $x_{1:t}$：現時刻までのロボットの経路
    - 姿勢のシーケンスとして表現。2次元平面ロボットの場合、$x_t=(x,y,\theta)^{\top}$
    - **前節で紹介した 「障害物が存在する状態 $x$」 とは意味が違うことに注意してください**

- $p(\boldsymbol{\rm{m_i}} |z_{1:t}, x_{1:t})$：「現時刻までのセンサ値 $z_{1:t}$」と「現時刻までの姿勢 $x_{1:t}$」から推定された「$i$ 番目のセル」が占有されている確立
:::
![image.png](https://qiita-image-store.s3.ap-northeast-1.amazonaws.com/0/2030125/9b42a7df-7761-226b-be2b-9d2a4c7f857c.png)

<br>

ここで、式(8)の「$i$ 番目のセルが占有されている確立 $p(\boldsymbol{\rm{m_i}} |z_{1:t}, x_{1:t})$」 の対数オッズをとった式は、前節で紹介したバイナリベイズフィルタの式(7)を用いて式(9)のように記述できます。
```math
l_{t,i} = \log\frac{p(\boldsymbol{\rm{m}}_i|z_{t}, x_{t})}{1-p(\boldsymbol{\rm{m}}_i|z_{t}, x_{t})} + l_{t-1, i} - \log\frac{p(\boldsymbol{\rm{m}}_i)}{1-p(\boldsymbol{\rm{m}}_i)} \tag{9}
```
::: note
- $l_{t,i}$：「現時刻までのセンサ値 $z_{1:t}$」と「現時刻までの姿勢 $x_{1:t}$」から推定された「$i$ 番目のセル」が占有されている確立の対数オッズ

- $\frac{p(\boldsymbol{\rm{m_i}}|z_{1:t}, x_{1:t})}{1-p(\boldsymbol{\rm{m_i}}|z_{1:t}, x_{1:t})}$：「現時刻のセンサ値 $z_{t}$」と「現時刻の姿勢 $x_{t}$」から推定された「$i$ 番目のセル」が占有されている確立の対数オッズ

- $l_{t-1,i}$：1時刻前の $l_{t, i}$

- $\frac{p(\boldsymbol{\rm{m_i}})}{1-p(\boldsymbol{\rm{m_i}})}$：「$i$ 番目のセル」が占有されている確立の対数オッズ（事前確立）

- $z_{1:t}$：現時刻までのセンサ値

- $x_{1:t}$：現時刻までのロボットの経路
    - 姿勢のシーケンスとして表現。2次元平面ロボットの場合、$x_t=(x,y,\theta)^{\top}$
:::

::: note warn
ここで、 $l_{t,i}$ は「$i$ 番目のセルが占有されている確立 $p(\boldsymbol{\rm{m_i}} |z_{1:t}, x_{1:t})$」そのものではなく、$p(\boldsymbol{\rm{m_i}} |z_{1:t}, x_{1:t})$の**対数オッズ**であることに注意してください。
:::

式(9)を，わかりやすいイメージで言い換えてみると
「新しい（=現時刻までの）占有格子地図（$1:t$）」=
 「現時刻のセンサ値 $z_t$とロボットの姿勢 $x_t$から推定された占有格子地図($t$)」 
　+ 「1時刻前までのセンサ値 $z_{1:t-1}$と1時刻前までのロボットの姿勢 $x_{1:t-1}$から推定された占有格子地図（$1:t-1$）」 
　- 「（事前確率）」
![image.png](https://qiita-image-store.s3.ap-northeast-1.amazonaws.com/0/2030125/432de9a4-6101-541e-7e9f-737acd64bf6c.png)
（上図では、3項目の「事前確立」は書いていません。）

<br>

ここまでで、占有格子地図における更新式を求めることができました。

<br>

::: note
式(9)は対数オッズであり、「$i$ 番目のセルが占有されている確立 $p(\boldsymbol{\rm{m_i}}|z_{1:t}, x_{1:t})$」そのものではないので、値の範囲は「-∞〜∞」になります。

前述したように、計算するときは対数オッズの形の方が扱いやすいですが、結果を人間が可視化する際は、「0〜1」の範囲である確立値の方が直感的にわかりやすいです。

そこで、式(10)を用いることで、対数オッズを確立値に変換することができます。

```math
p(\boldsymbol{\rm{m}}_i|z_{1:t}, x_{1:t}) = 1-\frac{1}{1+\exp\{l_{t, i} \}} \tag{10}
```
- $p(\boldsymbol{\rm{m_i}}|z_{1:t}, x_{1:t})$： 「現時刻までのセンサ値 $z_{1:t}$」と「現時刻までの姿勢 $x_{1:t}$」から推定された「$i$ 番目のセル」が占有されている確立

- $l_{t, i}$：「現時刻までのセンサ値 $z_{1:t}$」と「現時刻までの姿勢 $x_{1:t}$」から推定された「$i$ 番目のセル」が占有されている確立の対数オッズ
:::

## 占有格子地図を更新する具体例
ここからは、式(9)に実際の数値を当てはめてみて、占有格子地図がどのように更新されていくのかを確認してみましょう。

::: note warn
ここでは、式(9)の3項目にあたる「事前確率 $ \log\frac{p(\boldsymbol{\rm{m_i}})}{1-p(\boldsymbol{\rm{m_i}})}$」を考慮するとわかりにくくなるので、 $ \log\frac{p(\boldsymbol{\rm{m_i}})}{1-p(\boldsymbol{\rm{m_i}})} = \log\frac{0.5}{0.5} = 0$ である例を説明します。
:::



まず、$z_t=1$ の時は、
「セルが占有されていない状態である確率 $1 - p(\boldsymbol{\rm{m_i}}|z_{t}, x_{t})$」 < 「セルが占有されている状態である確率 $p(\boldsymbol{\rm{m_i}}|z_{t}, x_{t})$」
になるので、それぞれを $p(\boldsymbol{\rm{m_i}}|z_{t}, x_{t}) = 0.8, 1 - p(\boldsymbol{\rm{m_i}}|z_{t}, x_{t}) =0.2$ とすると
- 1時刻目：$l_{t,i} = \log\frac{0.8}{0.2} + 0.0 \fallingdotseq 1.39$ 
- 2時刻目：$l_{t,i} = \log\frac{0.8}{0.2} + 1.39 \fallingdotseq 2.77$
- 3時刻目：$l_{t,i} = \log\frac{0.8}{0.2} + 2.77 \fallingdotseq 4.15$ 

と対数オッズが上昇していきます。

これを、式（10）により確率値に変換すると
0.80 → 0.94 → 0.98
と徐々に「セルが占有されている確率 $p(\boldsymbol{\rm{m_i}}|z_{1:t}, x_{1:t})$ 」が上昇していることがわかります。
![image.png](https://qiita-image-store.s3.ap-northeast-1.amazonaws.com/0/2030125/060e5c1b-0109-ff85-a460-80db423c74dd.png)


<br>
<br>

逆に$z_t=0$ の時は、
「セルが占有されている状態である確率 $p(\boldsymbol{\rm{m_i}}|z_{t}, x_{t})$」 <  「セルが占有されていない状態である確率 $1 - p(\boldsymbol{\rm{m_i}}|z_{t}, x_{t})$」
になるので、それぞれを $p(\boldsymbol{\rm{m_i}}|z_{t}, x_{t}) = 0.2, 1 - p(\boldsymbol{\rm{m_i}}|z_{t}, x_{t}) =0.8$ とすると
- 1時刻目：$l_{t,i} = \log\frac{0.2}{0.8} + 0.0 \fallingdotseq -1.39$ 
- 2時刻目：$l_{t,i} = \log\frac{0.2}{0.8} + (-1.39) \fallingdotseq -2.77$
- 3時刻目：$l_{t,i} = \log\frac{0.2}{0.8} + (-2.77) \fallingdotseq -4.15$ 

と対数オッズが減少していきます。

これを、式（10）により確率値に変換すると 
0.20 → 0.06 → 0.01
と徐々に「セルが占有されている確率 $p(\boldsymbol{\rm{m_i}}|z_{1:t}, x_{1:t})$ 」が減少していることがわかります。
![image.png](https://qiita-image-store.s3.ap-northeast-1.amazonaws.com/0/2030125/7448de16-0bd5-748d-4228-ee489a4c4922.png)

# 最後に
以上が、ベイジアンフィルタによる占有格子地図の解説になります。

私も勉強中ですので、間違った解釈などがあればご教授いただけると幸いです。

また、ここまで記事をご覧になった方の中には「実際のプログラムで試してみたい！」という方もいると思います。私自身も時間があれば、自作に挑戦したいと思っているのですが、現時点では作成できていないので、下記のpythonコードをおすすめしたいと思います。

[https://gist.github.com/superjax/33151f018407244cb61402e094099c1d](https://gist.github.com/superjax/33151f018407244cb61402e094099c1d)

::: note warn 
こちらのコードでは、センサ値のみを用いて地図を更新しており $l_{t, i}(x)$ の3項目に相当する部分は含まれていないので注意してください。
:::

ロボティクスに興味のある方のお役に少しでも立てたら幸いです。


# 補足：マルコフ性が成り立たない時

マルコフ性が成り立たないパターンを考えてみます。
下図のように、移動ロボットが右に移動した時に占有グリッドがどうなるか考えてみます
![image.png](https://qiita-image-store.s3.ap-northeast-1.amazonaws.com/0/2030125/de7319a9-2b24-e392-30b0-487e94ac8fca.png)
実空間において、上図の上段のようにロボットが移動すると、
各時刻ごとに、上図の下段のような占有格子地図が作成されます。

<br>

そして、2時刻分の占有格子地図を統合すると下図左のようになります。
![image.png](https://qiita-image-store.s3.ap-northeast-1.amazonaws.com/0/2030125/305e92d4-d10f-a725-3d92-98e20753fa45.png)
ここで、統合後の占有格子地図を見てみると、
- 「2時刻目の占有格子地図の非占有領域」に「1時刻目のセンサの占有領域」が重なってしまっている（赤丸で示している箇所）

ことがわかります。

これは、マルコフ性の「過去の情報に一切依存しない」というルールに反します（仮に、マルコフ性が成り立つのならば、上図右側の「理想的な占有格子地図」になるはずです）。
よって、占有グリッドマップにおいてはマルコフ性は成り立ちません（厳密には，成り立たない時がある）。

しかし、マルコフ性が成り立たないとしても、本手法は有用であり、多くの場面において活用されています（実際は、パーティクルフィルターなどを組み合わせて精度を上げるなどの工夫がされているそうです）。


# 参考サイト、文献
- [Occupancy Maps](https://www.cs.cmu.edu/~16831-f14/notes/F14/16831_lecture06_agiri_dmcconac_kumarsha_nbhakta.pdf)：基本的に、こちらの文献をもとに作成しました。
- [Sebastian Thrun (著), Wolfram Burgard (著), Dieter Fox (著), 上田 隆一 (翻訳) (2016/9/21) 確率ロボティクス (プレミアムブックス版)](https://www.amazon.co.jp/%E7%A2%BA%E7%8E%87%E3%83%AD%E3%83%9C%E3%83%86%E3%82%A3%E3%82%AF%E3%82%B9-%E3%83%97%E3%83%AC%E3%83%9F%E3%82%A2%E3%83%A0%E3%83%96%E3%83%83%E3%82%AF%E3%82%B9%E7%89%88-Sebastian-Thrun/dp/4839952981/ref=asc_df_4839952981/?tag=jpgo-22&linkCode=df0&hvadid=295700463796&hvpos=&hvnetw=g&hvrand=9294327808047093147&hvpone=&hvptwo=&hvqmt=&hvdev=c&hvdvcmdl=&hvlocint=&hvlocphy=1009487&hvtargid=pla-525698820400&psc=1&th=1&psc=1)：ロボティクスの名著です。上記文献で理解しきれなかった部分を補足する形で読まさせていただきました。


[^1]:独立同一分布(i.i.d.)において、各確率は総乘の形で表すことができます。[参考：独立同一分布(i.i.d.)に従うってどういうことなんだ](https://engineeeer.com/iid-probability-statistics/)
[^2]:オッズ：事象の起こりやすさを表す指標のことで、「ある事象が起こる確率$p$」を「その事象が起こらない確率$１－p$で割ったもの」として定義されます。 起こる確率と起こらない確率が同じときにオッズの値は１となり、１よりも大きいと事象が起こりやすい、小さいと起こりにくいことを表します。















